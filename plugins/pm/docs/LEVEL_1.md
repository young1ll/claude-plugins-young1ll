# PM Plugin Design

GitHub Issues + Projects + Git 기반 자동화 프로젝트 관리 플러그인.

---

## 1. 핵심 원칙

이 플러그인은 개발자가 프로젝트 관리에 신경 쓰지 않아도 되도록 설계되었다. Claude Code 세션이 시작되면 자동으로 GitHub와 동기화하고, Git 컨텍스트를 감지한다. 개발자는 코드에만 집중하고, 나머지는 플러그인이 처리한다.

**Git-First 접근**: Git은 단순 버전 관리가 아닌 프로젝트 관리의 핵심 데이터 소스다. 브랜치, 커밋, PR, 태그가 Issue/Project 상태와 자동 연동된다.

**Git 로그 기반 이력 복원**: pm은 별도의 git-like 저장소를 만들지 않는다. SQLite는 조회/요약을 위한 캐시이며, 과거 작업 내역은 `git log`를 리플레이해 복원한다. 훅 누락이나 오프라인 구간도 로그 재구성으로 보정한다.

pm 플러그인은 2가지 모드로 동작한다: Local-based, GitHub+Local-based. `github_enabled`와 무관하게 git 이벤트(브랜치, 커밋, 메시지 키워드)를 통해 작업 흐름을 추적하며, 이 기록은 SQLite에 항상 반영된다.

### 원칙 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                           핵심 원칙                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│   │  Git-First  │     │ 완전 자동화  │     │ GitHub 기준 │          │
│   │             │     │             │     │             │          │
│   │ 브랜치=작업  │     │ 세션 시작 시 │     │ Issues/Proj │          │
│   │ 커밋=진행   │     │ 모든 것이   │     │ 필드별 SSOT │          │
│   │ PR=리뷰    │     │ 자동 실행   │     │ Git은 이벤트 │          │
│   │ 태그=릴리즈 │     │             │     │ 소스        │          │
│   └─────────────┘     └─────────────┘     └─────────────┘          │
│                                                                     │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│   │ 오프라인 우선 │     │  AI 보조    │     │ 변경 추적   │          │
│   │             │     │             │     │             │          │
│   │ 로컬 SQLite │     │ 자동 추정   │     │ git log/diff│          │
│   │ 로 즉시 작업 │     │ 자동 계획   │     │ 기반 분석   │          │
│   │ 온라인 시   │     │ 자동 회고   │     │ 코드 인사이트│          │
│   │ 자동 동기화 │     │             │     │             │          │
│   └─────────────┘     └─────────────┘     └─────────────┘          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 아키텍처

플러그인은 MCP 서버를 중심으로 동작한다. Git 이벤트(checkout, commit, push, merge)가 훅을 통해 MCP 서버로 전달되고, Issue/Project 상태가 자동 업데이트된다.

### 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Claude Code                                │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                         PM Plugin                               │ │
│  │                                                                 │ │
│  │   ┌──────────┐    ┌──────────┐    ┌──────────┐                │ │
│  │   │  Agents  │    │  Hooks   │    │ Commands │                │ │
│  │   │          │    │          │    │          │                │ │
│  │   │ Planner  │    │ PreCommit│    │ pm:sync  │                │ │
│  │   │ Executor │    │ PostComm │    │ pm:branch│                │ │
│  │   │ Reflector│    │ PrePush  │    │ pm:pr    │                │ │
│  │   └────┬─────┘    └────┬─────┘    └────┬─────┘                │ │
│  │        │               │               │                       │ │
│  │        └───────────────┼───────────────┘                       │ │
│  │                        │                                        │ │
│  │                 ┌──────┴──────┐                                │ │
│  │                 │  MCP Server │                                │ │
│  │                 │             │                                │ │
│  │                 │ Tools       │                                │ │
│  │                 │ Resources   │                                │ │
│  │                 │ Prompts     │                                │ │
│  │                 └──────┬──────┘                                │ │
│  │                        │                                        │ │
│  └────────────────────────┼────────────────────────────────────────┘ │
└───────────────────────────┼──────────────────────────────────────────┘
                            │
         ┌──────────────────┼──────────────────┐
         │                  │                  │
    ┌────┴────┐       ┌─────┴─────┐      ┌─────┴─────┐
    │   Git   │       │  SQLite   │      │  GitHub   │
    │ (Local) │       │  (Cache)  │      │   API     │
    └────┬────┘       └───────────┘      └─────┬─────┘
         │                                      │
         └──────────────────────────────────────┘
              양방향 동기화 (이벤트 기반)
```

### 데이터 흐름

```
Git 이벤트               플러그인 처리              GitHub 반영
─────────────────────────────────────────────────────────────

git checkout -b        →  이슈 컨텍스트 로드     →  (읽기)
  42-add-feature          작업 타이머 시작

git commit             →  커밋 메시지 파싱       →  Issue 코멘트 추가
  "feat: ... #42"         진행률 업데이트            (선택)

git push origin        →  원격 동기화 감지       →  Issue 상태 업데이트
                          PR 생성 제안

git merge/PR merge     →  완료 이벤트 기록       →  Issue 자동 종료
                          실제 시간 집계            Project 필드 업데이트

git tag v1.0.0         →  릴리즈 이벤트 감지     →  Release 자동 생성
                          연관 Issue 집계           릴리즈 노트 생성
```

### 에이전트 동작 흐름

Planner(Plan-and-Execute)는 다단계 목표를 계획으로 분해하고, Executor(ReAct)는 도구 호출과 관찰을 반복하며 실행한다. Reflector(Reflexion)는 결과와 추정 정확도를 반영해 요약과 규칙을 갱신한다. 훅은 세션 시작/종료 시 자동으로 컨텍스트를 복구/정리한다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                        에이전트 동작 흐름                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  User/Hook                                                          │
│     │                                                               │
│     ▼                                                               │
│  Task Classifier (규모/불확실성/반복성)                              │
│     │                                                               │
│     ├───────────────┐                                               │
│     │               ▼                                               │
│     │          Planner (Plan-and-Execute)                           │
│     │               │                                               │
│     │               ▼  계획/도구 시퀀스                              │
│     │          Executor (ReAct) ── MCP Tools/Resources ──► Observed │
│     │               │                                   결과/에러   │
│     │               └───────────────┐                               │
│     │                               ▼                               │
│     └───────────────────────── Reflector (Reflexion)                │
│                                      │                              │
│                                      ▼                              │
│                           요약/정책/추정 보정                        │
│                                      │                              │
│                                      ▼                              │
│                      SQLite (events, sessions, estimations)         │
│                                                                     │
│  Hooks: PreSession=요약 복원, PreTool=컨텍스트 제어, PostSession=요약 저장 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Git 워크플로우

GitHub Flow 기반의 단순하고 효율적인 워크플로우를 채택한다. 모든 작업은 브랜치에서 시작하고, PR을 통해 main에 병합된다. Git 이벤트가 프로젝트 관리 상태를 자동으로 업데이트한다.

### 브랜치 전략

```
┌─────────────────────────────────────────────────────────────────────┐
│                        브랜치 전략 (GitHub Flow)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  main ─────●────────●────────●────────●────────●─────────────────  │
│            │        ▲        │        ▲        │                   │
│            │        │        │        │        │                   │
│            │   ┌────┴────┐   │   ┌────┴────┐   │                   │
│            │   │  PR #2  │   │   │  PR #4  │   │                   │
│            │   │ merged  │   │   │ merged  │   │                   │
│            │   └────┬────┘   │   └────┬────┘   │                   │
│            │        │        │        │        │                   │
│            ▼        │        ▼        │        ▼                   │
│  42-feature ●───●───●       │        │        │                   │
│                             │        │        │                   │
│  43-bugfix ─────────────────●───●────●        │                   │
│                                               │                   │
│  44-refactor ─────────────────────────────────●───●               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 브랜치 명명 규칙

```
┌─────────────────────────────────────────────────────────────────────┐
│                         브랜치 명명 규칙                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  패턴: {issue_number}-{type}-{description}                          │
│                                                                     │
│  ┌──────────────┬───────────────────────────────────────────────┐  │
│  │    Type      │                 설명                           │  │
│  ├──────────────┼───────────────────────────────────────────────┤  │
│  │ feat         │ 새 기능 구현                                   │  │
│  │ fix          │ 버그 수정                                      │  │
│  │ refactor     │ 코드 개선 (기능 변경 없음)                     │  │
│  │ docs         │ 문서 작업                                      │  │
│  │ test         │ 테스트 추가/수정                               │  │
│  │ chore        │ 빌드/설정 작업                                 │  │
│  └──────────────┴───────────────────────────────────────────────┘  │
│                                                                     │
│  예시:                                                              │
│  - 42-feat-user-authentication                                     │
│  - 43-fix-login-redirect                                           │
│  - 44-refactor-api-client                                          │
│                                                                     │
│  자동 생성 명령:                                                    │
│  $ pm branch 42  →  git checkout -b 42-feat-issue-title            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 커밋 컨벤션 (Conventional Commits)

```
┌─────────────────────────────────────────────────────────────────────┐
│                       커밋 메시지 컨벤션                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  형식: <type>(<scope>): <description> [#issue]                      │
│                                                                     │
│  ┌──────────┬──────────────────────────────────────────────────┐   │
│  │  Type    │                    의미                           │   │
│  ├──────────┼──────────────────────────────────────────────────┤   │
│  │ feat     │ 새 기능 (MINOR 버전 증가)                         │   │
│  │ fix      │ 버그 수정 (PATCH 버전 증가)                       │   │
│  │ docs     │ 문서 변경                                         │   │
│  │ style    │ 포맷팅 (코드 동작 변경 없음)                       │   │
│  │ refactor │ 리팩토링 (기능/버그 수정 아님)                    │   │
│  │ test     │ 테스트 추가/수정                                  │   │
│  │ chore    │ 빌드/도구 변경                                    │   │
│  │ perf     │ 성능 개선                                         │   │
│  │ ci       │ CI 설정 변경                                      │   │
│  └──────────┴──────────────────────────────────────────────────┘   │
│                                                                     │
│  Breaking Change:                                                   │
│  - 본문에 BREAKING CHANGE: 포함 시 MAJOR 버전 증가                  │
│  - 또는 type 뒤에 ! 추가: feat!: breaking feature                   │
│                                                                     │
│  예시:                                                              │
│  - feat(auth): add OAuth2 support #42                              │
│  - fix(api): handle null response #43                              │
│  - docs: update API documentation                                   │
│  - feat!: redesign user API #44                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Magic Words (자동 상태 전이)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Magic Words                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  커밋 메시지 또는 PR 본문에서 인식                                   │
│                                                                     │
│  ┌────────────────┬─────────────────────────────────────────────┐  │
│  │   Magic Word   │                  동작                        │  │
│  ├────────────────┼─────────────────────────────────────────────┤  │
│  │ fixes #42      │ PR 머지 시 Issue #42 자동 종료               │  │
│  │ closes #42     │ PR 머지 시 Issue #42 자동 종료               │  │
│  │ resolves #42   │ PR 머지 시 Issue #42 자동 종료               │  │
│  │ refs #42       │ Issue 링크만 (상태 변경 없음)                │  │
│  │ relates #42    │ Issue 링크만 (상태 변경 없음)                │  │
│  │ blocks #42     │ Issue #42 블로커로 표시                      │  │
│  │ depends #42    │ Issue #42에 의존성 표시                      │  │
│  └────────────────┴─────────────────────────────────────────────┘  │
│                                                                     │
│  확장 Magic Words (플러그인 전용):                                   │
│                                                                     │
│  ┌────────────────┬─────────────────────────────────────────────┐  │
│  │ wip #42        │ Issue #42 상태를 In Progress로 변경          │  │
│  │ review #42     │ Issue #42 상태를 In Review로 변경            │  │
│  │ done #42       │ Issue #42 상태를 Done으로 변경               │  │
│  │ estimate 4h    │ 현재 작업에 예상 시간 기록                   │  │
│  │ spent 2h       │ 현재 작업에 소요 시간 기록                   │  │
│  └────────────────┴─────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. PR 워크플로우

PR은 코드 리뷰와 Issue 완료의 핵심 게이트웨이다. 브랜치 생성부터 PR 머지까지 전체 라이프사이클이 Issue 상태와 연동된다.

### PR 라이프사이클

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PR 라이프사이클                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  브랜치 생성                                                         │
│      │                                                              │
│      ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  git checkout -b 42-feat-user-auth                           │   │
│  │                                                              │   │
│  │  → Issue #42 상태: In Progress                               │   │
│  │  → 작업 타이머 시작                                           │   │
│  │  → 컨텍스트 자동 로드                                         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│      │                                                              │
│      ▼                                                              │
│  개발 & 커밋                                                         │
│      │                                                              │
│      ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  git push -u origin 42-feat-user-auth                        │   │
│  │                                                              │   │
│  │  → PR 생성 자동 제안                                          │   │
│  │  → PR 템플릿 자동 채움 (Issue 링크, 변경사항 요약)             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│      │                                                              │
│      ▼                                                              │
│  PR 생성                                                             │
│      │                                                              │
│      ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  gh pr create --title "feat: user auth" --body "fixes #42"   │   │
│  │                                                              │   │
│  │  → Issue #42 상태: In Review                                 │   │
│  │  → PR-Issue 양방향 링크 생성                                  │   │
│  │  → 자동 라벨 추가 (size, type)                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│      │                                                              │
│      ▼                                                              │
│  코드 리뷰                                                           │
│      │                                                              │
│      ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  PR 머지                                                      │   │
│  │                                                              │   │
│  │  → Issue #42 자동 종료 (fixes/closes 감지)                   │   │
│  │  → Project 상태: Done                                        │   │
│  │  → 작업 타이머 종료, 실제 시간 기록                           │   │
│  │  → 브랜치 자동 삭제 (설정 시)                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### PR 템플릿 자동 생성

```
브랜치명에서 추출한 정보 + 커밋 히스토리 + Issue 정보로 생성

┌─────────────────────────────────────────────────────────────────────┐
│  ## Summary                                                         │
│  {Issue 제목 및 설명 요약}                                           │
│                                                                     │
│  ## Changes                                                         │
│  - {커밋 메시지 기반 변경사항 목록}                                  │
│  - {파일 변경 통계}                                                 │
│                                                                     │
│  ## Related Issues                                                  │
│  Fixes #{issue_number}                                              │
│                                                                     │
│  ## Test Plan                                                       │
│  - [ ] {자동 생성된 테스트 체크리스트}                               │
│                                                                     │
│  ## Screenshots (if applicable)                                     │
│  {UI 변경 시 스크린샷 placeholder}                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### PR 라벨 자동화

```
자동 라벨 규칙:

Size Labels (변경된 라인 수 기준):
  - size/XS: < 10 lines
  - size/S: 10-50 lines
  - size/M: 50-200 lines
  - size/L: 200-500 lines
  - size/XL: > 500 lines

Type Labels (커밋 타입 기반):
  - type/feature: feat 커밋 포함
  - type/bugfix: fix 커밋 포함
  - type/refactor: refactor 커밋 포함
  - type/docs: docs 커밋만 포함
  - type/test: test 커밋 포함

Status Labels:
  - status/wip: Draft PR
  - status/ready: 리뷰 준비 완료
  - status/changes-requested: 변경 요청됨
  - status/approved: 승인됨
```

---

## 5. 코드 변경 분석

Git 히스토리를 분석하여 프로젝트 인사이트를 제공한다. 코드 변경 패턴, 핫스팟, 기여도를 추적하여 계획 수립과 회고에 활용한다.

### 분석 도구

```
┌─────────────────────────────────────────────────────────────────────┐
│                        코드 변경 분석 도구                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┬───────────────────────────────────────────┐  │
│  │      도구        │                 분석 내용                  │  │
│  ├──────────────────┼───────────────────────────────────────────┤  │
│  │ pm_git_stats     │ 기간별 커밋/라인 변경 통계                 │  │
│  │ pm_git_hotspots  │ 자주 변경되는 파일 (복잡도 위험)           │  │
│  │ pm_git_churn     │ 파일별 변경 빈도 (코드 품질 지표)          │  │
│  │ pm_git_ownership │ 파일별 주요 기여자                        │  │
│  │ pm_git_coupling  │ 함께 변경되는 파일 그룹                    │  │
│  │ pm_git_impact    │ PR/커밋의 영향 범위 분석                   │  │
│  └──────────────────┴───────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 핫스팟 분석

```
┌─────────────────────────────────────────────────────────────────────┐
│                         핫스팟 분석                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  변경 빈도 + 복잡도 = 리스크 스코어                                   │
│                                                                     │
│  복잡도 높음 ▲                                                       │
│              │                                                       │
│              │  ┌───────┐                    ┌───────┐              │
│              │  │ 리팩터 │                    │  위험  │              │
│              │  │링 대상 │                    │ 핫스팟 │              │
│              │  └───────┘                    └───────┘              │
│              │                                                       │
│              │  ┌───────┐                    ┌───────┐              │
│              │  │  안정  │                    │모니터링│              │
│              │  │       │                    │  필요  │              │
│              │  └───────┘                    └───────┘              │
│              │                                                       │
│              └──────────────────────────────────────────▶           │
│                                                    변경 빈도 높음    │
│                                                                     │
│  출력 예시:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  File                      │ Changes │ Complexity │ Risk   │   │
│  │  ─────────────────────────────────────────────────────────  │   │
│  │  src/api/client.ts         │    45   │    High    │  !!    │   │
│  │  src/utils/parser.ts       │    32   │    Med     │  !     │   │
│  │  src/components/Form.tsx   │    28   │    High    │  !!    │   │
│  │  src/services/auth.ts      │    15   │    Low     │  OK    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 커밋-이슈 매핑

```
┌─────────────────────────────────────────────────────────────────────┐
│                        커밋-이슈 매핑                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  pm_git_issue_commits { issue_id } → 해당 이슈의 모든 커밋           │
│  pm_git_commit_issues { sha } → 커밋에 연결된 모든 이슈              │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Issue #42: Add user authentication                         │   │
│  │  ───────────────────────────────────────────────────────    │   │
│  │  Commits:                                                    │   │
│  │    abc1234 feat(auth): add login form #42                   │   │
│  │    def5678 feat(auth): implement JWT validation #42         │   │
│  │    ghi9012 test(auth): add authentication tests #42        │   │
│  │    jkl3456 fix(auth): handle token expiry #42               │   │
│  │                                                              │   │
│  │  Stats:                                                      │   │
│  │    - 4 commits over 3 days                                  │   │
│  │    - +342 / -45 lines                                       │   │
│  │    - 12 files changed                                       │   │
│  │    - Primary author: developer@example.com                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 6. 릴리즈 관리

Git 태그 기반 릴리즈 관리. Semantic Versioning을 따르며, 커밋 히스토리에서 자동으로 릴리즈 노트를 생성한다.

### 버전 관리

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Semantic Versioning                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                    v MAJOR . MINOR . PATCH                          │
│                      │       │       │                              │
│                      │       │       └── 버그 수정 (fix:)           │
│                      │       └────────── 새 기능 (feat:)            │
│                      └────────────────── Breaking Change (!)        │
│                                                                     │
│  자동 버전 결정:                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  최근 릴리즈 이후 커밋 분석                                    │   │
│  │                                                              │   │
│  │  feat!: 또는 BREAKING CHANGE 포함  →  MAJOR 증가             │   │
│  │  feat: 포함                        →  MINOR 증가             │   │
│  │  fix: 만 포함                      →  PATCH 증가             │   │
│  │                                                              │   │
│  │  현재: v1.2.3                                                │   │
│  │  커밋: feat: new feature, fix: bug                          │   │
│  │  다음: v1.3.0                                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 릴리즈 노트 자동 생성

```
┌─────────────────────────────────────────────────────────────────────┐
│                     릴리즈 노트 자동 생성                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  pm_release_notes { from_tag?, to_ref? } → Markdown 릴리즈 노트     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  # v1.3.0 (2025-01-15)                                       │   │
│  │                                                              │   │
│  │  ## Features                                                 │   │
│  │  - Add user authentication (#42)                            │   │
│  │  - Implement OAuth2 support (#45)                           │   │
│  │                                                              │   │
│  │  ## Bug Fixes                                                │   │
│  │  - Fix login redirect issue (#43)                           │   │
│  │  - Handle null response in API (#46)                        │   │
│  │                                                              │   │
│  │  ## Documentation                                            │   │
│  │  - Update API documentation                                 │   │
│  │                                                              │   │
│  │  ## Other Changes                                            │   │
│  │  - Refactor API client                                      │   │
│  │  - Add unit tests for auth module                           │   │
│  │                                                              │   │
│  │  ---                                                         │   │
│  │  **Full Changelog**: v1.2.3...v1.3.0                        │   │
│  │  **Contributors**: @user1, @user2                           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. GitHub Issues/Projects 통합

GitHub Projects V2는 칸반 보드, 테이블, 로드맵 뷰와 커스텀 필드를 제공한다. Git 이벤트가 Issue/Project 상태를 자동으로 업데이트한다.

### Git-Issue 상태 매핑

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Git-Issue 상태 매핑                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Git 이벤트                    Issue 상태          Project 상태      │
│  ───────────────────────────────────────────────────────────────    │
│                                                                     │
│  branch 생성 (42-*)     →     open          →     In Progress      │
│  첫 커밋 (refs #42)     →     open          →     In Progress      │
│  push (원격)            →     open          →     In Progress      │
│  PR 생성                →     open          →     In Review        │
│  PR 머지 (fixes #42)    →     closed        →     Done             │
│  PR 머지 (refs #42)     →     open          →     In Progress      │
│  PR 종료 (unmerged)     →     open          →     Todo             │
│                                                                     │
│  역방향 (Project → Issue):                                          │
│  ───────────────────────────────────────────────────────────────    │
│  Project Status=Done    →     Issue closed  (옵션, 기본 off)        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 개념/관계 정의

- Project: repo-level GitHub Projects V2. 한 저장소당 기본 Project를 1개 선택한다.
- Issue: GitHub Issue. 제목/본문/코멘트와 open/closed 상태의 SSOT.
- Project Item: Project 안의 항목. Issue/PR/Draft Item을 참조할 수 있다.
- Draft Item: Project 전용 항목(아직 Issue/PR이 없는 계획 항목).
- Sub-Issue: 부모 Issue의 task list에 포함된 Issue. Issue 간 부모/자식 관계를 유지한다.

필드 소유권:
- Issue: title/body/comments, open/closed
- Project: status/priority/iteration/estimate
- Project 미소속 Issue: label/assignee 규칙으로 status/priority를 해석

### 필드 매핑

```
GitHub Project           ←──  Git 이벤트  ──→          Local DB
────────────────────────────────────────────────────────────────

┌─────────────────┐                      ┌─────────────────┐
│ Status          │                      │ items.status    │
│ (Single Select) │◄────── 자동 ────────►│ TEXT            │
│ Todo/InProg/    │                      │                 │
│ Review/Done     │                      │                 │
└─────────────────┘                      └─────────────────┘

┌─────────────────┐                      ┌─────────────────┐
│ Linked PRs      │                      │ items.pr_ids    │
│ (연결된 PR)     │◄─── gh pr create ───►│ JSON ARRAY      │
│                 │                      │                 │
└─────────────────┘                      └─────────────────┘

┌─────────────────┐                      ┌─────────────────┐
│ Commits         │                      │ events          │
│ (연결된 커밋)   │◄─── git commit ─────►│ .linked_commits │
│                 │                      │                 │
└─────────────────┘                      └─────────────────┘

┌─────────────────┐                      ┌─────────────────┐
│ Branch          │                      │ items           │
│ (작업 브랜치)   │◄─ git checkout -b ──►│ .branch_name    │
│                 │                      │                 │
└─────────────────┘                      └─────────────────┘
```

---

## 8. 동기화 엔진

동기화 엔진은 Git 이벤트, 로컬 SQLite 캐시, GitHub API 간 데이터 일관성을 유지한다. Git은 이벤트 소스, GitHub는 상태의 SSOT.

### 동기화 모델

```
┌─────────────────────────────────────────────────────────────────────┐
│                         동기화 엔진                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│         ┌─────────┐                         ┌─────────┐            │
│         │   Git   │                         │ GitHub  │            │
│         │ (이벤트)│                         │ (상태)  │            │
│         └────┬────┘                         └────┬────┘            │
│              │                                   │                  │
│              │         ┌───────────┐            │                  │
│              ├────────►│   Sync    │◄───────────┤                  │
│              │         │  Engine   │            │                  │
│              │◄────────┤           ├───────────►│                  │
│              │         └─────┬─────┘            │                  │
│              │               │                  │                  │
│              │         ┌─────┴─────┐            │                  │
│              │         │  SQLite   │            │                  │
│              └────────►│  (캐시)   │◄───────────┘                  │
│                        └───────────┘                               │
│                                                                     │
│  이벤트 흐름:                                                        │
│  1. Git 훅 → 이벤트 감지                                             │
│  2. SQLite 업데이트 (로컬 캐시)                                       │
│  3. GitHub API 호출 (온라인 시)                                       │
│  4. 응답 확인 및 캐시 동기화                                          │
│  5. 필요 시 git log 리플레이로 누락 이벤트 백필                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Git 훅 통합

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Git 훅 통합                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌────────────────┬─────────────────────────────────────────────┐  │
│  │     Hook       │                  동작                        │  │
│  ├────────────────┼─────────────────────────────────────────────┤  │
│  │ post-checkout  │ 브랜치 전환 감지, 이슈 컨텍스트 로드         │  │
│  │ pre-commit     │ 커밋 메시지 검증, 이슈 ID 자동 추가          │  │
│  │ post-commit    │ 커밋 이벤트 기록, 이슈 상태 업데이트         │  │
│  │ pre-push       │ 원격 동기화 트리거, PR 생성 제안             │  │
│  │ post-merge     │ 머지 완료 감지, 관련 이슈 정리               │  │
│  └────────────────┴─────────────────────────────────────────────┘  │
│                                                                     │
│  훅 설치 명령:                                                       │
│  $ pm hooks install                                                 │
│                                                                     │
│  훅 상태 확인:                                                       │
│  $ pm hooks status                                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### GitHub 연결 모드 (ON/OFF)

GitHub 연결은 언제든지 ON/OFF 전환 가능해야 한다. OFF 모드에서는 모든 API 호출을 중단하고 로컬 작업만 허용한다. ON으로 복귀하면 누적된 로컬 변경을 재검증 후 동기화한다.

```
┌─────────────────────────────────────────────────────────────────────┐
│                       GitHub 연결 모드                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   [ON]                                      [OFF]                   │
│   - Polling/Webhook 활성                    - API 호출 중지          │
│   - Sync Queue 실행                         - Sync Queue 일시정지    │
│   - 양방향 동기화                            - 로컬만 변경           │
│   - Git 훅: 항상 활성                        - Git 훅: 항상 활성      │
│                                                                     │
│   토글 경로: pm:sync --on|--off / 설정 파일                          │
│   자동 전환: 인증 실패/레이트리밋 감지 시 OFF, 알림 후 재시도         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

운영 규칙:
- OFF → ON 전환 시 먼저 GitHub Pull로 동기화 상태를 맞춘 뒤 로컬 변경을 재검증하고 Push한다.
- Git 훅 기반 이벤트(브랜치/커밋/메시지 파싱)는 모드와 무관하게 항상 기록한다.
- github_enabled 값은 SQLite `project_config.github_enabled`에 저장한다.

---

## 9. 자동화

### 충돌 우선순위/재동기화 규칙 (간단)

- Git은 이벤트 소스, GitHub는 상태의 SSOT, SQLite는 조회/요약 캐시로 역할을 고정한다.
- GitHub 상태 변경이 감지되면 로컬 이벤트는 재계산되며, 상태는 GitHub를 우선 적용한다.
- `git log` 리플레이 시 SHA+시간 기준으로 중복 이벤트를 제거하고 마지막 처리 커밋 포인터를 갱신한다.
- rebase/force-push 감지 시 해당 구간의 로컬 이벤트를 폐기하고 로그 재구성으로 링크를 복원한다.
- 충돌이 반복되면 자동 쓰기(상태 변경)를 중단하고 읽기 전용 모드로 전환한다.

자동화는 이 플러그인의 핵심이다. Git 작업 흐름에 자연스럽게 통합되어 개발자가 별도 명령 없이 프로젝트 관리가 이루어진다.

### 세션 라이프사이클

```
┌─────────────────────────────────────────────────────────────────────┐
│                       세션 라이프사이클                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Claude Code 시작                                                   │
│        │                                                            │
│        ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Pre-Session Hooks                         │   │
│  │                                                              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │   │
│  │  │ Git 상태 │─►│브랜치에서 │─►│GitHub    │─►│컨텍스트   │    │   │
│  │  │ 확인    │  │이슈 추출  │  │Sync Pull*│  │요약 복원  │    │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│        │                                                            │
│        ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      작업 세션                                │   │
│  │                                                              │   │
│  │   git checkout -b 42-feat-auth                              │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │   이슈 #42 컨텍스트 자동 로드 + 타이머 시작                   │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │   git commit -m "feat(auth): add login #42"                 │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │   이벤트 자동 기록 + 진행률 업데이트                          │   │
│  │         │                                                    │   │
│  │         ▼                                                    │   │
│  │   git push + PR 생성 제안                                    │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│        │                                                            │
│        ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   Post-Session Hooks                         │   │
│  │                                                              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │   │
│  │  │작업 시간 │─►│GitHub    │─►│세션 요약  │                  │   │
│  │  │집계      │  │Sync Push*│  │저장      │                  │   │
│  │  └──────────┘  └──────────┘  └──────────┘                  │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│        │                                                            │
│        ▼                                                            │
│  Claude Code 종료                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

* `Sync Pull*`/`Sync Push*`는 `github_enabled:true`일 때만 실행된다.

### 자동 컨텍스트 감지

```
┌─────────────────────────────────────────────────────────────────────┐
│                      자동 컨텍스트 감지                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  입력                      처리                     출력             │
│                                                                     │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│  │ git checkout│    │ 브랜치명 파싱    │    │ 이슈 컨텍스트    │    │
│  │ -b 42-feat  │───►│ /^(\d+)-/       │───►│ #42 로드        │    │
│  └─────────────┘    │ → issue_id: 42  │    │ 타이머 시작     │    │
│                     └─────────────────┘    └─────────────────┘    │
│                                                                     │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│  │ git commit  │    │ 메시지 파싱      │    │ 이벤트 기록      │    │
│  │ "feat: #42" │───►│ Conventional +  │───►│ + 상태 업데이트  │    │
│  └─────────────┘    │ Magic Words     │    └─────────────────┘    │
│                     └─────────────────┘                            │
│                                                                     │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│  │ PR merged   │    │ 연결된 이슈 확인 │    │ 이슈 자동 완료   │    │
│  │             │───►│ fixes/closes    │───►│ 실제 시간 기록   │    │
│  └─────────────┘    └─────────────────┘    └─────────────────┘    │
│                                                                     │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│  │ git tag     │    │ 태그 파싱       │    │ 릴리즈 생성      │    │
│  │ v1.0.0      │───►│ Semver 분석    │───►│ 릴리즈 노트      │    │
│  └─────────────┘    └─────────────────┘    └─────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 10. MCP 스펙

### Resources

```
pm://schema                      (테이블/필드/상태 옵션)
pm://config                      (project_config, github_enabled)
pm://context/active              (현재 작업 컨텍스트 + Git 상태)
pm://git/status                  (현재 Git 상태 요약)
pm://git/branch                  (현재 브랜치 정보)
pm://views/board?status=...      (칸반 요약)
pm://summary/level1|level2|level3 (요약 레벨)
```

### Tools

```
# Issue/Item 관리
pm_item_list { filters, limit?, cursor?, view? } -> { items[], next_cursor? }
pm_item_get { id } -> { item }
pm_item_create { title, type, status?, priority? } -> { item }
pm_item_update { id, patch } -> { item }
pm_item_transition { id, status } -> { item }

# Git 통합
pm_git_branch_create { issue_id } -> { branch_name }
pm_git_commit_link { sha, issue_id } -> { event_id }
pm_git_pr_create { issue_id, title?, body? } -> { pr_url }
pm_git_pr_template { issue_id } -> { template }

# Git 분석
pm_git_stats { from?, to?, author? } -> { commits, lines_added, lines_removed }
pm_git_hotspots { limit? } -> { files[] }
pm_git_churn { path?, days? } -> { files[] }
pm_git_coupling { path } -> { coupled_files[] }
pm_git_issue_commits { issue_id } -> { commits[] }

# 릴리즈
pm_release_next_version {} -> { current, next, commits[] }
pm_release_notes { from?, to? } -> { markdown }
pm_release_create { version, notes? } -> { release_url }

# 동기화
pm_sync_pull { force? } -> { pulled_counts }
pm_sync_push { dry_run? } -> { pushed_counts }

# 분석
pm_metrics_velocity { sprint_count? } -> { velocity, trend }
pm_metrics_burndown { sprint_id } -> { points[] }
```

### Prompts

```
pm_sprint_plan         # 스프린트 계획 (velocity + backlog)
pm_retrospective       # 회고 (Git 분석 포함)
pm_risk_scan          # 리스크 스캔 (핫스팟 분석)
pm_release_plan       # 릴리즈 계획 (버전 + 변경사항)
pm_code_review        # 코드 리뷰 가이드 (변경 분석)
```

---

## 11. DB 스키마 확장

### Core Tables

```
items              project_config       iterations
├─ id              ├─ github_project_id ├─ id
├─ type            ├─ field_mappings    ├─ title
├─ github_*_id     ├─ status_options    ├─ start_date
├─ status          ├─ github_enabled    ├─ duration
├─ priority        └─ synced_at
├─ iteration_id
├─ branch_name     (Git 연결)
├─ pr_ids          (연결된 PR)
└─ parent_issue_id
```

### Git 이벤트 테이블

```sql
CREATE TABLE git_events (
    id TEXT PRIMARY KEY,
    event_type TEXT NOT NULL,  -- 'commit', 'branch', 'merge', 'tag', 'push'
    ref TEXT,                  -- branch name or tag
    sha TEXT,                  -- commit SHA
    message TEXT,              -- commit message
    author TEXT,
    author_email TEXT,
    files_changed INTEGER,
    lines_added INTEGER,
    lines_removed INTEGER,
    issue_ids TEXT,            -- JSON array of linked issue IDs
    pr_number INTEGER,
    created_at TEXT NOT NULL
);

CREATE INDEX idx_git_events_type ON git_events(event_type);
CREATE INDEX idx_git_events_sha ON git_events(sha);
CREATE INDEX idx_git_events_created ON git_events(created_at);
```

### 릴리즈 테이블

```sql
CREATE TABLE releases (
    id TEXT PRIMARY KEY,
    version TEXT NOT NULL,           -- Semantic version (v1.2.3)
    tag_name TEXT NOT NULL,
    title TEXT,
    notes TEXT,                      -- Markdown release notes
    commits TEXT,                    -- JSON array of commit SHAs
    issues_closed TEXT,              -- JSON array of closed issue IDs
    published_at TEXT,
    created_at TEXT NOT NULL
);
```

### 코드 분석 캐시

```sql
CREATE TABLE code_analysis_cache (
    file_path TEXT PRIMARY KEY,
    complexity_score REAL,
    change_frequency INTEGER,
    last_modified TEXT,
    primary_author TEXT,
    coupled_files TEXT,              -- JSON array
    analyzed_at TEXT NOT NULL
);
```

---

## 12. 컨텍스트/토큰 운영 규칙

### 요약 레벨 및 트리거

```
Level 0 (Raw)   : 개별 이벤트/코멘트/툴 출력
Level 1 (Story) : 20 메시지마다 핵심 결정/블로커 요약
Level 2 (Epic)  : 주간 또는 마일스톤마다 위험/의존성 요약
Level 3 (Project) : 세션 종료 시 프로젝트 건강 상태 요약
```

### 운영 규칙

- 컨텍스트 사용량이 70%를 넘기기 전 요약을 실행한다.
- 요약 후 작업 공간(빈 컨텍스트)은 40~50%를 유지한다.
- 테이블형 데이터는 JSON 대신 CSV/TSV로 직렬화한다.
- 대량 조회는 요약 뷰(카운트/그룹) → 상세 뷰 순서로 점진 호출한다.
- 서브에이전트 결과는 300~500 토큰 이내 요약만 메인에 전달한다.

---

## 13. 구현 우선순위

| Phase | 항목 |
|-------|------|
| 1 | Git 훅 통합 (checkout, commit, push) |
| 2 | 브랜치-이슈 자동 연결 |
| 3 | 커밋 메시지 파싱 (Conventional Commits + Magic Words) |
| 4 | PR 워크플로우 자동화 |
| 5 | Git 분석 도구 (stats, hotspots, churn) |
| 6 | 릴리즈 자동화 (versioning, notes) |
| 7 | GitHub Issues/Projects 동기화 |
| 8 | AI 에이전트 통합 (Planner, Executor, Reflector) |
